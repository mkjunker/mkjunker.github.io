
<html>
  <head>
    <title>Displaying JSON Data</title>
    <script>
      // https://www.w3schools.com/jsref/met_document_addeventlistener.asp
      window.addEventListener('load',init,false);
      function init(e){
          documentLoader()
          // document.getElementById('myButton').addEventListener('click',documentLoader,false);
      }

      var output = ""
      var forecast = ""

      function tempstr(degc) {
          if (degc === null) {
              return null
          }
          return ((degc * 9 / 5) + 32).toFixed() + " F"
      }

      function windstr(properties) {
          var out = "Wind:";
          if( properties.windDirection.value !== null ) {
              out += " ";
              out += properties.windDirection.value.toString();
          }
          if( properties.windSpeed.value !== null ) {
              out += " ";
              out += (properties.windSpeed.value
                      * 15625 / 25146).toFixed();
              out += " MPH";
          }
          if( properties.windGust.value ) {
              out += " gust ";
              out += (properties.windGust.value
                      * 15625 / 25146).toFixed();
              out += " MPH";
          }
          return out;
      }

      function reqListener () {
          // convert the string from the file to an object with JSON.parse
          var obj = JSON.parse(this.responseText);

          var date = new Date(obj.properties.timestamp);
          var now = new Date()
          output += '<details><summary><samp>'
          var data = date.toString().split(' ');
          output += obj.properties.rawMessage.substr(0,4) + ' '
              + data[4].substr(0,5) + ' ' + data[0] + ', '
              + data[1] + ' ' + data[2];
          output += ': ' + tempstr(obj.properties.temperature.value);
          output += ' ' + obj.properties.textDescription;
          if ((now - date) > 7200000) {
              output += '  <span style="color:red">OLD</span> '
          }
          output += "</samp></summary>";
          output += ("Temperature: "
                     + tempstr(obj.properties.temperature.value))
          if (obj.properties.windChill.value !== null) {
              output += ' '
              output += "WC: " + tempstr(obj.properties.windChill.value)
          }
          if (obj.properties.heatIndex.value !== null) {
              output += ' '
              output += "HI: " + tempstr(obj.properties.heatIndex.value)
          }
          if (obj.properties.dewpoint.value !== null) {
              output += ' '
              output += "DP: " + tempstr(obj.properties.dewpoint.value)
          }
          if (obj.properties.relativeHumidity.value !== null) {
              output += ' RH:';
              output +=
                  obj.properties.relativeHumidity.value.toFixed();
              output += '%';
          }
          output += "<br>"
          output += "Conditions: " + obj.properties.textDescription;
          output += " ";
          if( obj.properties.barometricPressure.value !== null ) {
              output += ' Baro: ';
              output += (obj.properties.barometricPressure.value
                         * (152 / 514731)).toFixed(2);
              output += ' inHg';
          }
          output += ' ';
          output += windstr(obj.properties);
          output += "<br>"
          output += ('<span style="color:green"><small>'
                     + obj.properties.rawMessage + '</small></span></details>')
          document.getElementById('conditions').innerHTML = output

      }

      function parseForecast() {
          var obj = JSON.parse(this.responseText);

          forecast += '<h4><a href="https://forecast.weather.gov/MapClick.php?lat=43.2371&lon=-87.9703&unit=0&lg=english">Forecast</a></h4>';
          for(p in obj.time.startPeriodName) {
              forecast += "<details><summary>";
              forecast += '<span style="width:2in">';
              forecast += obj.time.startPeriodName[p] + ": ";
              // Can we make the remainder at a fixed horizontal
              // position?
              forecast += '</span>';
              forecast += obj.data.temperature[p] + " F, ";
              forecast += obj.data.weather[p];
              forecast += "</summary>"
              forecast += '<div style="margin-left:0.25in">';
              forecast += obj.data.text[p];
              forecast += '</div>';
              forecast += "</details>"
          }
          document.getElementById('forecast').innerHTML = forecast;
      }

      function documentLoader(){
          var oReq;
          var stations = ["KMWC", "KETB", "KUES", "KMKE"]
          for(sta in stations)
          {
              oReq = new XMLHttpRequest();
              oReq.onload = reqListener;
              oReq.open("get", "https://api.weather.gov/stations/" + stations[sta] + "/observations/latest", true);
              oReq.send();
          }
          var pReq;
          pReq = new XMLHttpRequest();
          pReq.onload = parseForecast;
          pReq.open("get", "https://forecast.weather.gov/MapClick.php?lat=43.2371&lon=-87.9703&unit=0&lg=english&FcstType=json", true);
          pReq.send();

      }
    </script>
  </head>
  <body>
    <div id="conditions"></div>
    <div id="forecast"></div>
  </body>
</html>
